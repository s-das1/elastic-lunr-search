<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="/public/css/styles.css">
</head>

<body>
    <div class="search_container">
        <form action="/search_results/" method="GET">
            <h1>Asset search</h1>
            <div class="search">
                <input type="text" id="search_box" name="search">
                <button class="button button1" type="submit" id="search_button">Search</button>
            </div>
        </form>
        <h2 id="Search_results_header"></h2>
        <div class="search_results" id="search_results_id">
            <div id="search_results_section_id"></div>
        </div>
    </div>
    <script>
        //Gets the term being searched 
        function getSearchTerm() {
            const url = new URL(window.location.href);
            return url.searchParams.get("search");
        }

        //Forms API call
        function formApiUrl() {
            const url_aws = 'https://c19814fb3a47419f917cff32b3fd56f9.vfs.cloud9.eu-west-1.amazonaws.com/search_results/api/v1/?search=';
            const url_local = 'http://localhost:3000/search_results/api/v1/?search=';
            const url_heroku = 'https://agile-sierra-20588.herokuapp.com/search_results/api/v1?search=';
            return url_local + getSearchTerm();
        }

        if (getSearchTerm() != null) {
            //Setting the search term and setting it to the search box (required as a new page has been opened)
            //Then fetching the search term via the API
            document.getElementById('search_box').value = getSearchTerm();
            fetch(formApiUrl())
                .then(data => {
                    return data.json()
                })
                .then(res => {
                    if (res.length === 0) { 
                        //This is needed to ensure that there is an empty div nested in the search results class, 
                        //otherwise follow on searches don't have a div to be inputted into
                        const div = document.createElement('div');
                        div.id = 'search_results_section_id';
                        div.innerHTML = '';
                        document.getElementById('search_results_id').appendChild(div);
                    } else {
                    //Iteratively adding each div to the search results
                        document.getElementById("Search_results_header").innerHTML = res.length + " results found";
                        for (let i = 0; i < res.length; i++) {
                            const div = document.createElement('div');
                            div.className = 'search_results_section';
                            div.id = 'search_results_section_id';
                            div.innerHTML = '<p1> <strong>' + res[i].Asset + '</strong> </p1>\
                                             <p> <strong>Owner:</strong> ' + res[i].Owner + '</p>\
                                             <p> <strong>Status:</strong> ' + res[i].Status + '</p>\
                                             <p> <strong>Description:</strong> ' + res[i].Description + '</p>';
                            document.getElementById('search_results_id').appendChild(div);
                        }
                    }
                })
        }
    </script>
</body>

</html>